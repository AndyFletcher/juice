#!/usr/bin/env flusspferd
// -*- mode:javascript; -*- vim:ts=2:sw=2:expandtab:autoindent:filetype=javascript:enc=utf-8:
 

var io = require( "io" ),
    system = require( "system" ),
    os = require( "os" );

var JuiceCLI = {
  init : function ( name ) {
    // if name wasn't provided, exit
    if ( name === undefined ) throw "Usage: juice init my-new-project";

    // if directory already exists, exit
    if ( io.File.exists( name ) ) throw "Directory " + name + " already exists";

    // create the directory structure
    var tree = [
      name + "/db",
      name + "/lib",
      name + "/script",
      name + "/static/scripts",
      name + "/static/styles",
      name + "/templates"
    ];
    os.system( "mkdir -p " + tree.join( " " ) );

    // lib/app.js
    var lib_app_js = <><![CDATA[// Don't mess with this
var juice = require('juice');
var app = new juice.Application;

var DOC_ROOT = module.uri.replace(/^.*?:\/\/(.*?)lib\/]]></> + name + <><![CDATA[\.js$/, "$1") || "./";

// Your actions (well, just one action for now)
app.controllers.index = function( env ) {
  return {
    docroot : env.juice.docRoot
  }
}

app.controllers.test_x = function() {
  return {
    status: 200,
    headers: {
      'x-sendfile': DOC_ROOT + "static" + this.env.pathInfo
    },
    body: [ '' ]
  }
}

// URL mappings
app.actions = {
  "/" : "index",
  "/(?:styles|scripts)/.*?": { action: "test_x", raw: true }
};

// Don't mess with this, either
exports.app = app.setup( DOC_ROOT );
]]></> + "";
    io.File( name + "/lib/" + name + ".js", "w" ).print( lib_app_js );

    // templates/index.tt
    var templates_index_tt = <><![CDATA[<!DOCTYPE html>
<html>
<head>
  <title>Welcome to Juice</title>
  <link rel="stylesheet" type="text/css" href="/styles/app.css">
</head>
<body>
  <h1>Welcome to Juice</h1>
  <p>To get started open up <code>[% docroot %]lib/]]></> + name + <><![CDATA[.js</code> in your
  favourite editor and start poking around.</p>
</body>
</html>]]></> + "";
    io.File( name + "/templates/index.tt", "w" ).print( templates_index_tt );

    // static/styles/app.css
    var static_styles_app_css = <><![CDATA[* { margin: 0; padding: 0; }]]></> + "";
    io.File( name + "/static/styles/app.css", "w" ).print( static_styles_app_css );

    // script/server
    var script_server = <><![CDATA[#!/usr/bin/env flusspferd -I lib

var server = require( 'zest' ).Zest( {
  handler: require( ']]></> + name + <><![CDATA[' ).app
} );

server.start();
]]></> + "";
    io.File.create( name + "/script/server", 0777 );
    io.File( name + "/script/server", "w" ).print( script_server );
  }
}

var args = system.args.slice( 1 );
var action = args.shift();

if ( action in JuiceCLI )
  JuiceCLI[ action ].apply( undefined, args );
else
  throw "Valid actions: init";
